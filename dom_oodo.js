const saleteam=["Lưu Phan Hoàng Phúc","Nguyễn Thị Linh Đan","Lê Đinh Ý Nhi","Mai Thị Nữ"],saleAvatar={"Lưu Phan Hoàng Phúc":"./DOM-img/phuc.jpg","Nguyễn Thị Linh Đan":"./DOM-img/dan.jpg","Lê Đinh Ý Nhi":"./DOM-img/ynhi.jpg","Mai Thị Nữ":"./DOM-img/nu.jpg"},tagName={126:"Status - New",127:"Bad-timing",128:"Junk",129:"Qualified",154:"Unqualified",170:"Needed"},tagWon={96:"DBA",143:"EMBA UMEF",155:"SBS",156:"ASC",201:"MBA UMEF",203:"BBA",206:"MSc AI"},sale_switch=document.querySelectorAll(".sale_switch");let salesData=[];const PROXY="https://ideas.edu.vn/wp-admin/network/NewFolder/proxy.php";async function loginOdoo(){document.querySelector(".loading").classList.add("active");const e=await fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/session/authenticate",data:{jsonrpc:"2.0",params:{db:"IBM_Prod",login:"numt@ideas.edu.vn",password:"1"}}})}),t=await e.json();if(document.querySelector(".loading").classList.remove("active"),t.result&&t.result.uid)return t.result;throw new Error("Login failed!")}function getDateFilterArgs(){let e,t;if(startDateGlobal&&endDateGlobal)e=startDateGlobal,t=endDateGlobal;else{const a=new Date;e=new Date(a.getFullYear(),a.getMonth(),1).toISOString().split("T")[0],t=new Date(a.getFullYear(),a.getMonth()+1,0).toISOString().split("T")[0]}return[[["create_date",">=",e],["create_date","<=",t]]]}function getDateWonArg(){let e,t;if(startDateGlobal&&endDateGlobal)e=startDateGlobal,t=endDateGlobal;else{const a=new Date;e=new Date(a.getFullYear(),a.getMonth(),1).toISOString().split("T")[0],t=new Date(a.getFullYear(),a.getMonth()+1,0).toISOString().split("T")[0]}return[[["won_status","=","won"],["date_last_stage_update",">=",e],["date_last_stage_update","<=",t]]]}function checkDateTime(){let e=[];if(preset){e=formatDateRange(getFormattedDateRange(preset))}else startDateGlobal&&endDateGlobal&&(e=getDateFilterArgs());return e}function checkDateTimeWon(){let e=[];if(preset){e=formatDateRangeWon(getFormattedDateRange(preset))}else startDateGlobal&&endDateGlobal&&(e=getDateWonArg());return e}async function fetchWonLeadsThisYear(){let e;document.querySelector(".loading").classList.add("active");try{const t=await fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/dataset/call_kw",data:{jsonrpc:"2.0",method:"call",params:{model:"crm.lead",method:"search_read",args:checkDateTimeWon(),kwargs:{fields:["name","create_date","contact_name","partner_id","email_from","phone","tag_ids","user_id","__last_update","medium_id","source_id","campaign_id","date_last_stage_update","won_status"],limit:0}}}})}),a=await t.json();if(!a.result)throw new Error("Không có dữ liệu hoặc lỗi API.");e=a.result.sort(((e,t)=>new Date(e.date_last_stage_update)-new Date(t.date_last_stage_update)));const n=new Array(12).fill(0);e.forEach((e=>{const t=new Date(e.date_last_stage_update).getMonth();n[t]++})),drawWonLeadsChart(n),drawWonLeadsByProgramChart(e);const o=e.map((e=>e.partner_id?.[0])).filter((e=>e));e=await fetchInvoicesByPartnerIds(o,e)}catch(e){}finally{document.querySelector(".loading").classList.remove("active")}return e}async function fetchInvoicesByPartnerIds(e,t){if(!e.length)return[];try{const a=await fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/dataset/call_kw",data:{jsonrpc:"2.0",method:"call",params:{model:"account.move",method:"search_read",args:[[["partner_id","in",e],["move_type","=","out_invoice"],["payment_state","=","paid"]]],kwargs:{fields:[],limit:0}}}})}),n=await a.json();if(!n.result)throw new Error("Không lấy được hóa đơn.");const o={};return n.result.forEach((e=>{const t=e.partner_id[0];o[t]=(o[t]||0)+e.amount_total_signed})),t.forEach((e=>{const t=e.partner_id?.[0];e.amount_total_signed=o[t]||0})),t}catch(e){return[]}}let wonChartInstance=null;function drawWonLeadsChart(e){const t=document.getElementById("wonChart").getContext("2d");window.wonChartInstance&&window.wonChartInstance.destroy(),window.wonChartInstance=new Chart(t,{type:"bar",data:{labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],datasets:[{label:"Leads Won",data:e,backgroundColor:"rgba(255, 171, 0,0.9)",borderColor:"rgba(255, 171, 0,1)",borderWidth:1}]},options:{responsive:!0,plugins:{legend:{display:!1},title:{display:!1}},scales:{y:{beginAtZero:!0}}}})}async function fetchLeads(){document.querySelector(".loading").classList.add("active"),salesData=[];const e=await fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/dataset/call_kw",data:{jsonrpc:"2.0",method:"call",params:{model:"crm.lead",method:"search_read",args:checkDateTime(),kwargs:{fields:["tag_ids","user_id"],limit:0}}}})}),t=await e.json();return document.querySelector(".loading").classList.remove("active"),t.result}function makeColor(e){let t="rgba(255, 99, 132, 1)";return"Needed"==e||("Status - New"==e?t="rgb(255, 68, 0)":"Bad-Timing"==e?t="rgb(108, 0, 86)":"Unqualified"==e?t="rgb(229, 217, 0)":"Junk"==e&&(t="rgb(0, 0, 0)")),t}function makeColorWon(e){let t="rgb(0, 80, 133)";return"MSc AI"==e||("EMBA UMEF"==e?t="rgb(0, 136, 146)":"ASC"==e?t="rgb(184, 141, 0)":"SBS"==e?t="rgb(255, 81, 0)":"MBA UMEF"==e?t="rgb(255, 0, 0)":"DBA"==e?t="rgb(196, 0, 153)":"BBA"==e&&(t="rgb(5, 160, 0)")),t}function renderUloodo(e,t){let a=e[t];const n=document.querySelector(".dom_chart_most_ul.oodo");if(a){let a=Object.entries(e[t]).sort(((e,t)=>t[1]-e[1])),o=a.map((([e,t])=>e)),r=a.map((([e,t])=>t));n.innerHTML="",o.forEach(((e,t)=>{if(0==t)return;const a=document.createElement("li");a.innerHTML=`<p><span>${e}</span> <span>${r[t]}</span></p> <p> <span style="width: ${100*r[t]/r[0]}%; background: ${makeColor(e)}"></span> </p>`,n.appendChild(a)}))}else n.innerHTML=""}function renderWon(e){const t=document.querySelector(".dom_detail_tbody_oodo");t.innerHTML="",e.forEach((e=>{const a=e.user_id?e.user_id[1]:"Khác",n=document.createElement("tr");n.innerHTML=`\n    <td>${formatDate(e.date_last_stage_update)||""}</td>\n    <td>${formatDate(e.create_date)||""}</td>\n    <td> <span style="background: ${makeColorWon(getTagDisplayWon(e.tag_ids))}"></span>${getTagDisplayWon(e.tag_ids)||""}</td>\n    <td>${e.contact_name||""}</td>\n    <td>${e.email_from||""}</td>\n    <td>${e.phone||""}</td>\n    <td>${formatCurrency(e.amount_total_signed)||""}</td>\n    <td> <img src="${saleAvatar[a]}"/> <span>${a}</span></td>\n    <td>${e.source_id[1]||""}</td>\n    <td>${e.campaign_id[1]||""}</td>\n    <td>${e.medium_id[1]||""}</td>\n  `,t.appendChild(n)})),updateTableFooter(e)}function updateTableFooter(e){const t=document.querySelector("#dom_table_oodo");let a=t.querySelector("#dom_table_oodo tfoot");a&&a.remove();const n=e.length,o=e.reduce(((e,t)=>e+(t.amount_total_signed||0)),0),r=document.createElement("tfoot");r.innerHTML=`\n    <tr>\n      <td style="text-align:center" colspan="3"><strong>TOTAL ${n} Won</strong></td>\n      <td ></td>\n      <td ></td>\n      <td ></td>\n      <td><strong>${formatCurrency(o)}</strong></td>\n      <td ></td>\n      <td colspan="3"></td>\n    </tr>\n  `,t.appendChild(r)}function processAndRenderLeads(e){e.forEach((e=>{const t=e.user_id?e.user_id[1]:"Khác";if(saleteam.includes(t)&&(salesData[t]||(salesData[t]={total:0,Needed:0,"Status - New":0,"Bad-Timing":0,Unqualified:0,Junk:0}),salesData[t].total++,e.tag_ids&&Array.isArray(e.tag_ids))){const a=[...new Set(e.tag_ids)];a.includes(129)||a.includes(170)?salesData[t].Needed++:a.includes(126)?salesData[t]["Status - New"]++:a.includes(127)?salesData[t]["Bad-Timing"]++:a.includes(154)?salesData[t].Unqualified++:a.includes(128)&&salesData[t].Junk++}})),renderChart(salesData),renderUloodo(salesData,saleteam[0]),calculateTotalSalesData(salesData)}function renderProgressBar(e){const t=document.querySelector("#progressBar"),a=document.querySelector(".progess_label"),n=document.querySelector(".oodo_total");t.innerHTML="",a.innerHTML="";const o=Object.values(e).reduce(((e,t)=>e+t),0);n.innerText=o,Object.entries(e).forEach((([e,n])=>{if(n>0){const r=(n/o*100).toFixed(1),s=document.createElement("p");s.classList.add("segment"),s.style=`width:${r}%; background:${makeColor(e)}`,t.appendChild(s);const d=document.createElement("p");d.innerHTML=`<span style="background: ${makeColor(e)}"></span>${e}: <b>${n} (${r}%)</b>`,a.appendChild(d)}}))}function calculateTotalSalesData(e){const t={Needed:0,"Status - New":0,"Bad-Timing":0,Unqualified:0,Junk:0};Object.values(e).forEach((e=>{t.Needed+=e.Needed||0,t["Status - New"]+=e["Status - New"]||0,t["Bad-Timing"]+=e["Bad-Timing"]||0,t.Unqualified+=e.Unqualified||0,t.Junk+=e.Junk||0})),renderProgressBar(t)}sale_switch.forEach(((e,t)=>{e.addEventListener("click",(()=>{setActive(e,".sale_switch.active"),renderUloodo(salesData,saleteam[t])}))}));let reachChartInstanceOodo=null;function renderChart(e){null!==reachChartInstanceOodo&&reachChartInstanceOodo.destroy();const t=Object.keys(e);renderLabel=t.map((e=>{const t=e.split(" ");return t[t.length-1]}));const a=t.map((t=>e[t].total)),n=t.map((t=>e[t].Needed)),o=document.getElementById("leadChart").getContext("2d");reachChartInstanceOodo=new Chart(o,{type:"bar",data:{labels:renderLabel,datasets:[{label:"Total Lead",data:a,backgroundColor:"rgba(255, 171, 0,1)",borderWidth:1},{label:"Needed",data:n,backgroundColor:"rgba(255, 99, 132, 1)",borderWidth:1}]},options:{plugins:{legend:{display:!0},tooltip:{enabled:!0},datalabels:{anchor:"end",align:"top",color:"#7c7c7c",font:{size:11,weight:"bold"},formatter:e=>e}},responsive:!0,scales:{y:{beginAtZero:!0,ticks:{font:{size:9}},afterDataLimits:e=>{e.max*=1.15}}}},plugins:[ChartDataLabels]})}async function main(){try{await loginOdoo();const[e,t]=await Promise.all([fetchLeads(),fetchWonLeadsThisYear()]);processAndRenderLeads(e),renderWon(t)}catch(e){}}function getRound(e,t,a){return"Form"===e&&"Facebook IDEAS"===t&&"FB Ads"===a?"Vòng Form":"Mess/Web/Hotline"}function formatTagName(e){return e?e.toLowerCase().replace(/\s*-\s*/g,"_").replace(/\s+/g,"_"):""}function getTagDisplay(e){if(!e||0===e.length)return"";if(e.includes(129)||e.includes(170))return"Needed";for(let t of e)if(tagName[t])return tagName[t];return""}function getTagDisplayWon(e){if(!e||0===e.length)return"";for(let t of e)if(tagWon[t])return tagWon[t];return""}function getTagDisplayNeeded(e){return e.includes(129)||e.includes(170)?"Needed":null}function filterTable(e){const t=document.querySelectorAll(".dom_table_container.oodo tbody tr");let a=[];t.forEach((t=>{const n=t.children[5].textContent.trim().toLowerCase(),o=normalizeVietnamese(t.children[7].textContent.trim().toLowerCase()),r=t.children[2].textContent.trim().toLowerCase(),s=normalizeVietnamese(t.children[3].textContent.trim().toLowerCase());n.includes(e)||o.includes(e)||r.includes(e)||s.includes(e)?(t.style.display="",a.push({amount_total_signed:formatCurrencyToNumber(t.children[6].textContent)||0})):t.style.display="none"})),updateTableFooter(a)}function formatDateRange(e){if(!e)return[];const t=e.split(" - ").map((e=>{const[t,a,n]=e.split("/");return`${n}-${a}-${t}`})),a=t[0];return[[["create_date",">=",a],["create_date","<=",t[1]||a]]]}function formatDateRangeWon(e){if(!e)return[];const t=e.split(" - ").map((e=>{const[t,a,n]=e.split("/");return`${n}-${a}-${t}`})),a=t[0];return[[["won_status","=","won"],["date_last_stage_update",">=",a],["date_last_stage_update","<=",t[1]||a]]]}document.querySelector("#dom_detail_input.oodo").addEventListener("input",(function(){filterTable(normalizeVietnamese(this.value.trim().toLowerCase()))})),document.querySelector("#dom_detail_find.oodo").addEventListener("click",(function(){const e=document.getElementById("dom_table_oodo");if(!e)return;const t=XLSX.utils.book_new(),a=XLSX.utils.table_to_sheet(e);XLSX.utils.book_append_sheet(t,a,"Sheet1"),XLSX.writeFile(t,"export.xlsx")}));let wonProgramChartInstance=null;function drawWonLeadsByProgramChart(e){const t=document.getElementById("wonProgramChart").getContext("2d"),a={};e.forEach((e=>{const t=getTagDisplayWon(e.tag_ids);t&&(a[t]=(a[t]||0)+1)}));const n=Object.keys(a),o=Object.values(a);0!==o.length&&(window.wonProgramChartInstance&&window.wonProgramChartInstance.destroy(),window.wonProgramChartInstance=new Chart(t,{type:"bar",data:{labels:n,datasets:[{label:"Leads by Program",data:o,backgroundColor:"rgba(255, 171, 0,0.9)",borderColor:"rgba(255, 171, 0,1)",borderWidth:1}]},options:{barPercentage:.4,responsive:!0,plugins:{legend:{display:!1},title:{display:!1}},scales:{y:{beginAtZero:!0}}}}))}function normalizeVietnamese(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/đ/g,"d").replace(/Đ/g,"D")}function formatCurrencyToNumber(e){return parseFloat(e.replace(/\./g,"").replace("đ","").trim())}
