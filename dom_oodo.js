const saleteam=["Lưu Phan Hoàng Phúc","Nguyễn Thị Linh Đan","Lê Đinh Ý Nhi","Mai Thị Nữ","Nguyễn Thị Hà Miên"],saleAvatar={"Lưu Phan Hoàng Phúc":"./DOM-img/phuc.jpg","Nguyễn Thị Linh Đan":"./DOM-img/dan.jpg","Lê Đinh Ý Nhi":"./DOM-img/ynhi.jpg","Mai Thị Nữ":"./DOM-img/nu.jpg","Nguyễn Thị Hà Miên":"./DOM-img/hamien.png"},tagName={126:"Status - New",127:"Bad-timing",128:"Junk",129:"Qualified",154:"Unqualified",170:"Needed"},tagWon={96:"DBA",143:"EMBA UMEF",155:"SBS",156:"ASC",201:"MBA UMEF",203:"BBA",206:"MSc AI"},sale_switch=document.querySelectorAll(".sale_switch"),PROXY="https://ideas.edu.vn/wp-admin/network/NewFolder/proxy.php";let loginPromise=loginOdoo();async function ensureLogin(){await loginPromise}async function loginOdoo(){const e=await fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/session/authenticate",data:{jsonrpc:"2.0",params:{db:"IBM_Prod",login:"numt@ideas.edu.vn",password:"1"}}})}),t=await e.json();if(t.result&&t.result.uid)return t.result;throw new Error("Login failed!")}function getDateFilterArgs(){let e,t;if(startDateGlobal&&endDateGlobal)e=startDateGlobal,t=endDateGlobal;else{const a=new Date;e=new Date(a.getFullYear(),a.getMonth(),1).toISOString().split("T")[0],t=new Date(a.getFullYear(),a.getMonth()+1,0).toISOString().split("T")[0]}return[[["create_date",">=",e],["create_date","<=",t]]]}let viewStartOodo=null,viewEndOodo=null;function getDateWonArg(){let e,t;if(startDateGlobal&&endDateGlobal)e=startDateGlobal,t=endDateGlobal,viewStartOodo=startDateGlobal,viewEndOodo=endDateGlobal;else{const a=new Date;e=new Date(a.getFullYear(),a.getMonth(),1).toISOString().split("T")[0],t=new Date(a.getFullYear(),a.getMonth()+1,0).toISOString().split("T")[0]}return[[["date_last_stage_update",">=",e],["date_last_stage_update","<=",t],["stage_id","in",[4,6]]]]}function checkDateTime(){let e=[];if(date_preset){e=formatDateRange(getFormattedDateRange(date_preset))}else startDateGlobal&&endDateGlobal&&(e=getDateFilterArgs());return e}function checkDateTimeWon(){let e=[];if(date_preset){e=formatDateRangeWon(getFormattedDateRange(date_preset))}else startDateGlobal&&endDateGlobal&&(e=getDateWonArg());return e}async function fetchWonLeadsThisYear(){try{const e=await fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/dataset/call_kw",data:{jsonrpc:"2.0",method:"call",params:{model:"crm.lead",method:"search_read",args:checkDateTimeWon(),kwargs:{fields:["name","create_date","contact_name","partner_id","email_from","phone","tag_ids","user_id","medium_id","source_id","campaign_id","date_last_stage_update","stage_id"],limit:0}}}})}),t=await e.json();if(!t.result||!Array.isArray(t.result))throw new Error("Không có dữ liệu hoặc lỗi API.");const a=new Uint8Array(12),n=[],o=new Set;for(const e of t.result){if(4===e.stage_id?.[0]){n.push(e);a[new Date(e.date_last_stage_update).getMonth()]++}e.partner_id?.[0]&&o.add(e.partner_id[0])}const r=fetchInvoicesByPartnerIds([...o],t.result);return drawWonLeadsChart(a),drawWonLeadsByProgramChart(n),await r}catch(e){return[]}}async function fetchInvoicesByPartnerIds(e,t){if(!e.length)return t;try{const a=500,n=[];for(let t=0;t<e.length;t+=a)n.push(e.slice(t,t+a));const o=n.map((e=>fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/dataset/call_kw",data:{jsonrpc:"2.0",method:"call",params:{model:"account.move",method:"search_read",args:[[["partner_id","in",e],["move_type","=","out_invoice"]]],kwargs:{fields:["partner_id","amount_total_signed","invoice_date","payment_state"],order:"invoice_date asc",limit:0}}}})}).then((e=>e.json())))),r=(await Promise.all(o)).flatMap((e=>e.result||[])),d={},s={},i={},l={},c=new Date(viewStartOodo),u=new Date(viewEndOodo);for(const{partner_id:e,amount_total_signed:t,invoice_date:a,payment_state:n}of r){const o=e[0],r=new Date(a);l[o]||(l[o]=[]),l[o].push({invoice_date:a}),s[o]=(s[o]||0)+t,"paid"===n&&(d[o]=(d[o]||0)+t,r>=c&&r<=u&&(i[o]=(i[o]||0)+t))}for(const e of t){const t=e.partner_id?.[0];e.amount_total_signed=d[t]||0,e.amount_total_pre=s[t]||0,e.amount_total_month=i[t]||0;const a=l[t]||[];e.first_invoice=a.length?a[0].invoice_date:null,e.first_invoice&&e.create_date?e.conversion_days=Math.floor((new Date(e.first_invoice)-new Date(e.create_date))/864e5):e.conversion_days=null}return document.querySelector(".loading").classList.remove("active"),t}catch(e){return document.querySelector(".loading").classList.remove("active"),t}}let wonChartInstance=null;function drawWonLeadsChart(e){const t=document.getElementById("wonChart").getContext("2d");window.wonChartInstance&&window.wonChartInstance.destroy(),window.wonChartInstance=new Chart(t,{type:"bar",data:{labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],datasets:[{label:"Leads Won",data:e,backgroundColor:"rgba(255, 171, 0,0.9)",borderColor:"rgba(255, 171, 0,1)",borderWidth:1}]},options:{responsive:!0,plugins:{legend:{display:!1},title:{display:!1}},scales:{y:{beginAtZero:!0}}}})}async function fetchLeads(){const e=await fetch(PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:"/web/dataset/call_kw",data:{jsonrpc:"2.0",method:"call",params:{model:"crm.lead",method:"search_read",args:checkDateTime(),kwargs:{fields:["tag_ids","user_id"],limit:0}}}})});return(await e.json()).result}function makeColor(e){let t="rgba(255, 99, 132, 1)";return"Needed"==e||("Status - New"==e?t="rgb(255, 68, 0)":"Bad-Timing"==e?t="rgb(108, 0, 86)":"Unqualified"==e?t="rgb(229, 217, 0)":"Junk"==e&&(t="rgb(0, 0, 0)")),t}function makeColorWon(e){let t="rgb(0, 80, 133)";return"MSc AI"==e||("EMBA UMEF"==e?t="rgb(0, 136, 146)":"ASC"==e?t="rgb(184, 141, 0)":"SBS"==e?t="rgb(255, 81, 0)":"MBA UMEF"==e?t="rgb(255, 0, 0)":"DBA"==e?t="rgb(196, 0, 153)":"BBA"==e&&(t="rgb(5, 160, 0)")),t}function renderUloodo(e,t){let a=e[t];const n=document.querySelector(".dom_toplist.oodo");if(a){let a=Object.entries(e[t]).sort(((e,t)=>t[1]-e[1])),o=a.map((([e,t])=>e)),r=a.map((([e,t])=>t));n.innerHTML="",o.forEach(((e,t)=>{if(0==t)return;const a=document.createElement("li");a.innerHTML=`<p><span>${e}</span> <span>${r[t]}</span></p> <p> <span style="width: ${100*r[t]/r[0]}%; background: ${makeColor(e)}"></span> </p>`,n.appendChild(a)}))}else n.innerHTML=""}function renderWon(e){const t=document.querySelector(".table.oodo tbody");t.innerHTML="",e.forEach((e=>{const a=e.user_id?e.user_id[1]:"Khác",n=document.createElement("tr");n.innerHTML=`\n      <td>${formatDate(e.date_last_stage_update)||""}</td>\n      <td>${formatDate(e.create_date)||""}</td>\n      <td>${""+(e.conversion_days?`${formatNumber(e.conversion_days)} days`:"No Invoice")||""}</td>\n      <td> <span style="background: ${makeColorWon(getTagDisplayWon(e.tag_ids))}"></span>${getTagDisplayWon(e.tag_ids)||""}</td>\n      <td>${e.contact_name||""}</td>\n      <td>${e.email_from||""}</td>\n      <td>${e.phone||""}</td>\n      <td>${e.stage_id[1]||""}</td>\n      <td>${formatCurrency(e.amount_total_month)||""}</td>\n      <td>${formatCurrency(e.amount_total_signed)||""}</td>\n      <td>${formatCurrency(e.amount_total_pre)||""}</td>\n      <td> <img src="${saleAvatar[a]}"/> <span>${a}</span></td>\n      <td>${e.source_id[1]||""}</td>\n      <td>${e.campaign_id[1]||""}</td>\n      <td>${e.medium_id[1]||""}</td>\n    `,t.appendChild(n)})),updateTableFooter(e)}function updateTableFooter(e){const t=document.querySelector("#won_table.table.oodo");let a=document.querySelector("#won_table.table.oodo tfoot");a&&a.remove();let n=0;n=e.length;const{totalAmount:o,totalPreAmount:r,totalMonth:d}=e.reduce(((e,t)=>(e.totalAmount+=t.amount_total_signed||0,e.totalPreAmount+=t.amount_total_pre||0,e.totalMonth+=t.amount_total_month||0,e)),{totalAmount:0,totalPreAmount:0,totalMonth:0}),s=document.createElement("tfoot");s.innerHTML=`\n      <tr>\n        <td style="text-align:center" colspan="3"><strong>TOTAL ${n} ROW</strong></td>\n        <td ></td>\n        <td ></td>\n        <td ></td>\n        <td ></td>\n        <td ></td>\n        <td><strong>${formatCurrency(d)}</strong></td>\n        <td><strong>${formatCurrency(o)}</strong></td>\n        <td><strong>${formatCurrency(r)}</strong></td>\n        <td ></td>\n        <td colspan="3"></td>\n      </tr>\n    `,t.appendChild(s)}function processAndRenderLeads(e){const t={};e.forEach((({user_id:e,tag_ids:a})=>{const n=e?e[1]:"Khác";if(!saleteam.includes(n))return;let o=t[n]??={total:0,Needed:0,"Status - New":0,"Bad-Timing":0,Unqualified:0,Junk:0};if(o.total++,Array.isArray(a)){let e=new Set(a);e.has(129)||e.has(170)?o.Needed++:e.has(126)?o["Status - New"]++:e.has(127)?o["Bad-Timing"]++:e.has(154)?o.Unqualified++:e.has(128)&&o.Junk++}})),salesDataGlobal=t,renderChart(t),renderUloodo(t,saleteam[0]),calculateTotalSalesData(t)}function renderProgressBar(e){const t=document.querySelector("#progressBar"),a=document.querySelector(".progess_label"),n=document.querySelector(".oodo_total");t.replaceChildren(),a.replaceChildren();let o=Object.values(e).reduce(((e,t)=>e+t),0);if(n.innerText=o,0===o)return;let r=document.createDocumentFragment(),d=document.createDocumentFragment();Object.entries(e).forEach((([e,t])=>{if(0===t)return;const a=(t/o*100).toFixed(1),n=makeColor(e);let s=document.createElement("p");s.classList.add("segment"),s.style=`width:${a}%; background:${n}`,r.appendChild(s);let i=document.createElement("p");i.innerHTML=`<span style="background: ${n}"></span>${e}: <b>${t} (${a}%)</b>`,d.appendChild(i)})),t.appendChild(r),a.appendChild(d)}function calculateTotalSalesData(e){const t={Needed:0,"Status - New":0,"Bad-Timing":0,Unqualified:0,Junk:0};Object.values(e).forEach((e=>{t.Needed+=e.Needed||0,t["Status - New"]+=e["Status - New"]||0,t["Bad-Timing"]+=e["Bad-Timing"]||0,t.Unqualified+=e.Unqualified||0,t.Junk+=e.Junk||0})),renderProgressBar(t)}sale_switch.forEach(((e,t)=>{e.addEventListener("click",(()=>{renderUloodo(salesDataGlobal,saleteam[t]),setActiveOnly(e,".sale_switch.active")}))}));let reachChartInstanceOodo=null;function renderChart(e){null!==reachChartInstanceOodo&&reachChartInstanceOodo.destroy();const t=Object.keys(e),a=t.map((e=>{const t=e.split(" ");return t[t.length-1]})),n=t.map((t=>e[t].total)),o=t.map((t=>e[t].Needed)),r=document.getElementById("leadChart").getContext("2d");reachChartInstanceOodo=new Chart(r,{type:"bar",data:{labels:a,datasets:[{label:"Total Lead",data:n,backgroundColor:"rgba(255, 171, 0,1)",borderWidth:1},{label:"Needed",data:o,backgroundColor:"rgba(255, 99, 132, 1)",borderWidth:1}]},options:{plugins:{legend:{display:!0},tooltip:{enabled:!0},datalabels:{anchor:"end",align:"top",color:"#7c7c7c",font:{size:11,weight:"bold"},formatter:e=>e}},responsive:!0,scales:{y:{beginAtZero:!0,ticks:{font:{size:9}},afterDataLimits:e=>{e.max*=1.15}}}},plugins:[ChartDataLabels]})}async function main(){document.querySelector(".loading").classList.add("active");try{await ensureLogin();const[e,t]=await Promise.all([fetchLeads(),fetchWonLeadsThisYear()]);processAndRenderLeads(e),renderWon(t)}catch(e){}}function getRound(e,t,a){return"Form"===e&&"Facebook IDEAS"===t&&"FB Ads"===a?"Vòng Form":"Mess/Web/Hotline"}function formatTagName(e){return e?e.toLowerCase().replace(/\s*-\s*/g,"_").replace(/\s+/g,"_"):""}function getTagDisplay(e){if(!e||0===e.length)return"";if(e.includes(129)||e.includes(170))return"Needed";for(let t of e)if(tagName[t])return tagName[t];return""}function getTagDisplayWon(e){if(!e||0===e.length)return"";for(let t of e)if(tagWon[t])return tagWon[t];return"Unknow Tag"}function getTagDisplayNeeded(e){return e.includes(129)||e.includes(170)?"Needed":null}function filterTable(e){const t=document.querySelectorAll("table.table.oodo tbody tr");let a=[];t.forEach((t=>{const n=t.children[6].textContent.trim().toLowerCase(),o=t.children[7].textContent.trim().toLowerCase(),r=normalizeVietnamese(t.children[11].textContent.trim().toLowerCase()),d=t.children[2].textContent.trim().toLowerCase(),s=normalizeVietnamese(t.children[4].textContent.trim().toLowerCase());n.includes(e)||r.includes(e)||d.includes(e)||s.includes(e)||o.includes(e)?(t.style.display="",a.push({amount_total_month:formatCurrencyToNumber(t.children[8].textContent)||0,amount_total_signed:formatCurrencyToNumber(t.children[9].textContent)||0,amount_total_pre:formatCurrencyToNumber(t.children[10].textContent)||0})):t.style.display="none"})),updateTableFooter(a)}function formatDateRange(e){if(!e)return[];const t=e.split(" - ").map((e=>{const[t,a,n]=e.split("/");return`${n}-${a}-${t}`})),a=t[0];return[[["create_date",">=",a],["create_date","<=",t[1]||a]]]}function formatDateRangeWon(e){if(!e)return[];const t=e.split(" - ").map((e=>{const[t,a,n]=e.split("/");return`${n}-${a}-${t}`})),a=t[0],n=t[1]||a;return viewStartOodo=a,viewEndOodo=n,[[["date_last_stage_update",">=",a],["date_last_stage_update","<=",n],["stage_id","in",[4,6]]]]}document.querySelector(".dom_search.oodo").addEventListener("input",(function(){filterTable(normalizeVietnamese(this.value.trim().toLowerCase()))})),document.querySelector(".dom_export_main.oodo").addEventListener("click",(function(){const e=document.getElementById("dom_table_oodo");if(!e)return;const t=XLSX.utils.book_new(),a=XLSX.utils.table_to_sheet(e);XLSX.utils.book_append_sheet(t,a,"Sheet1"),XLSX.writeFile(t,"export.xlsx")}));let wonProgramChartInstance=null;function drawWonLeadsByProgramChart(e){const t=document.getElementById("wonProgramChart").getContext("2d");window.wonProgramChartInstance&&window.wonProgramChartInstance.destroy();const a={};e.forEach((e=>{const t=getTagDisplayWon(e.tag_ids);t&&(a[t]=(a[t]||0)+1)}));const n=Object.keys(a),o=Object.values(a);0!==o.length&&(window.wonProgramChartInstance=new Chart(t,{type:"bar",data:{labels:n,datasets:[{label:"Leads by Program",data:o,backgroundColor:"rgba(255, 171, 0,0.9)",borderColor:"rgba(255, 171, 0,1)",borderWidth:1}]},options:{barPercentage:.4,responsive:!0,plugins:{legend:{display:!1},title:{display:!1}},scales:{y:{beginAtZero:!0}}}}))}function normalizeVietnamese(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/đ/g,"d").replace(/Đ/g,"D")}function formatCurrencyToNumber(e){return parseFloat(e.replace(/\./g,"").replace("đ","").trim())}
